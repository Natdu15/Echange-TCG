<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="logo-tcg.png" href="logo-tcg.png">
    <link rel="stylesheet" href="css/trade.css">
    <title>Trading de Cartes</title>
</head>

<body>
    <div class="container">
        <!-- Page 1: Recherche d'amis -->
        <div id="searchPage">
            <h1>üîÑ Rechercher un Ami</h1>

            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Rechercher un ami...">
            </div>

            <div id="friendList" class="friend-list">
                <!-- Les amis seront charg√©s ici -->
            </div>
        </div>

        <!-- Page 2: Mes cartes √† √©changer -->
        <div id="cardsPage" class="hidden">
            <button class="btn btn-back" onclick="goToSearch()">‚Üê Retour</button>
            <h1>Trader avec <span id="friendName"></span></h1>
            <p class="subtitle">S√©lectionnez une carte √† proposer</p>

            <div class="cards-section">
                <h2>üÉè Mes Cartes</h2>
                <div id="myCardsList" class="cards-grid"></div>
            </div>
        </div>

        <!-- Page 3: En attente de r√©ponse -->
        <div id="waitingPage" class="hidden">
            <div class="waiting-page">
                <div class="timer-label">‚è∞ Temps restant</div>
                <div class="timer" id="timer">23:59:45</div>

                <h1 style="margin-bottom: 20px;">Offre envoy√©e √† <span id="waitingFriendName"></span></h1>

                <div class="floating-card-container">
                    <div class="floating-card">
                        <img id="waitingCardImage" src="" alt="Carte en attente">
                    </div>
                </div>

                <div class="waiting-text">‚è≥ En attente d'une r√©ponse...</div>

                <button class="btn btn-primary" onclick="cancelTrade()" style="max-width: 300px; margin: 40px auto 0;">
                    ‚ùå Annuler l'offre
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>ü§ù Confirmer l'√©change</h2>
            <p class="subtitle">Voulez-vous proposer cette carte ?</p>

            <div class="modal-card-preview">
                <img id="modalCardImage" class="modal-card-image" src="" alt="Carte">
                <h3 id="modalCardName" style="margin-bottom: 10px;"></h3>
                <span id="modalCardRarity" class="card-rarity"></span>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="btn btn-confirm" onclick="confirmTrade()">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Images al√©atoires pour les cartes selon la raret√©
        const cardImages = {
            common: [
                'https://images.unsplash.com/photo-1550684376-efcbd6e3f031?w=400&h=600&fit=crop',
                'https://images.unsplash.com/photo-1579547621113-e4bb2a19bdd6?w=400&h=600&fit=crop',
                'https://images.unsplash.com/photo-1516975080664-ed2fc6a32937?w=400&h=600&fit=crop'
            ],
            rare: [
                'https://images.unsplash.com/photo-1614732414444-096e5f1122d5?w=400&h=600&fit=crop',
                'https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=400&h=600&fit=crop',
                'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=400&h=600&fit=crop'
            ],
            legendary: [
                'https://images.unsplash.com/photo-1534447677768-be436bb09401?w=400&h=600&fit=crop',
                'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=400&h=600&fit=crop',
                'https://images.unsplash.com/photo-1511447333015-45b65e60f6d5?w=400&h=600&fit=crop'
            ]
        };

        let friends = [];
        let myCards = [];
        let selectedFriend = null;
        let selectedCard = null;

        // Initialisation
        function init() {
            loadFriends();
            loadCards();
            displayFriends();
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            startTimer();
        }

        function loadFriends() {
            const storedFriends = localStorage.getItem('friends');
            if (storedFriends) {
                friends = JSON.parse(storedFriends);
            }
        }

        function loadCards() {
            const storedCards = localStorage.getItem('myCards');
            if (storedCards) {
                myCards = JSON.parse(storedCards);
                // Assigner des images al√©atoires
                myCards = myCards.map(card => ({
                    ...card,
                    image: getRandomImage(card.rarity)
                }));
            } else {
                // Donn√©es de test
                myCards = [
                    { id: 1, name: 'Dragon C√©leste', rarity: 'legendary', power: 250, image: getRandomImage('legendary') },
                    { id: 2, name: 'Chevalier Noir', rarity: 'rare', power: 180, image: getRandomImage('rare') },
                    { id: 3, name: 'Mage de Glace', rarity: 'rare', power: 160, image: getRandomImage('rare') },
                    { id: 4, name: 'Archer Elfe', rarity: 'common', power: 100, image: getRandomImage('common') },
                    { id: 5, name: 'Guerrier', rarity: 'common', power: 90, image: getRandomImage('common') }
                ];
            }
        }

        function getRandomImage(rarity) {
            const images = cardImages[rarity] || cardImages.common;
            return images[Math.floor(Math.random() * images.length)];
        }

        function displayFriends(filter = '') {
            const list = document.getElementById('friendList');
            list.innerHTML = '';

            const filteredFriends = friends.filter(f =>
                f.name.toLowerCase().includes(filter.toLowerCase())
            );

            if (friends.length === 0) {
                list.innerHTML = `
                    <div class="no-friends">
                        <div class="no-friends-icon">üë•</div>
                        <h2 style="margin-bottom: 15px;">Aucun ami</h2>
                        <p style="font-size: 1.2rem; color: #9ca3af;">Veuillez ajouter des amis avant de trader</p>
                    </div>
                `;
                return;
            }

            if (filteredFriends.length === 0) {
                list.innerHTML = `
                    <div class="no-friends">
                        <div class="no-friends-icon">üîç</div>
                        <h2>Aucun r√©sultat</h2>
                        <p style="color: #9ca3af;">Aucun ami ne correspond √† votre recherche</p>
                    </div>
                `;
                return;
            }

            filteredFriends.forEach(friend => {
                const card = document.createElement('div');
                card.className = `friend-card ${!friend.online ? 'offline' : ''}`;
                card.onclick = () => friend.online && selectFriend(friend);

                const initials = friend.name.substring(0, 2).toUpperCase();

                card.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${initials}</div>
                        <div>
                            <div class="card-name">${friend.name}</div>
                            <div class="friend-status ${friend.online ? 'online' : 'offline-text'}">
                                ${friend.online ? 'üü¢ En ligne' : '‚ö´ Hors ligne'}
                            </div>
                        </div>
                    </div>
                    ${friend.online ? '<div style="font-size: 1.5rem;">‚Üí</div>' : ''}
                `;

                list.appendChild(card);
            });
        }

        function handleSearch(e) {
            displayFriends(e.target.value);
        }

        function selectFriend(friend) {
            selectedFriend = friend;
            document.getElementById('friendName').textContent = friend.name;
            displayMyCards();
            showPage('cardsPage');
        }

        function displayMyCards() {
            const list = document.getElementById('myCardsList');
            list.innerHTML = '';

            if (myCards.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üÉè</div>
                        <p>Aucune carte disponible</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Ajoutez des cartes √† votre collection</p>
                    </div>
                `;
                return;
            }

            myCards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = `card-item ${selectedCard?.id === card.id ? 'selected' : ''}`;
                cardEl.onclick = () => openConfirmModal(card);

                cardEl.innerHTML = `
                    <img src="${card.image}" alt="${card.name}" class="card-image">
                    <div class="card-name">${card.name}</div>
                    <span class="card-rarity ${card.rarity}">${getRarityLabel(card.rarity)}</span>
                    <div class="card-stats">‚ö° Puissance: ${card.power}</div>
                `;

                list.appendChild(cardEl);
            });
        }

        function getRarityLabel(rarity) {
            const labels = {
                common: '‚ö™ Commun',
                rare: 'üîµ Rare',
                legendary: 'üü° L√©gendaire'
            };
            return labels[rarity] || rarity;
        }

        function openConfirmModal(card) {
            selectedCard = card;

            document.getElementById('modalCardImage').src = card.image;
            document.getElementById('modalCardName').textContent = card.name;
            const rarityEl = document.getElementById('modalCardRarity');
            rarityEl.textContent = getRarityLabel(card.rarity);
            rarityEl.className = `card-rarity ${card.rarity}`;

            document.getElementById('confirmModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        function confirmTrade() {
            closeModal();
            document.getElementById('waitingFriendName').textContent = selectedFriend.name;
            document.getElementById('waitingCardImage').src = selectedCard.image;
            showPage('waitingPage');
        }

        function cancelTrade() {
            selectedCard = null;
            goToSearch();
        }

        function goToSearch() {
            selectedFriend = null;
            selectedCard = null;
            showPage('searchPage');
        }

        function showPage(pageId) {
            const pages = ['searchPage', 'cardsPage', 'waitingPage'];
            pages.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        // Timer fictif de 24h
        let timeRemaining = 24 * 60 * 60 - 15; // 23:59:45

        function startTimer() {
            setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;

            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer').textContent = display;
        }

        // D√©marrage
        init();
    </script>
</body>

</html>
