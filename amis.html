// Base de donnÃ©es simulÃ©e d'utilisateurs (Ã  remplacer par une vraie BD plus tard)
const userDatabase = [
    { id: 'user_1', username: 'Nathan', online: true },
    { id: 'user_2', username: 'Maxime', online: false },
    { id: 'user_3', username: 'Sophie', online: true },
    { id: 'user_4', username: 'Lucas', online: false },
    { id: 'user_5', username: 'Emma', online: true },
    { id: 'user_6', username: 'Thomas', online: false },
    { id: 'user_7', username: 'Chloe', online: true },
    { id: 'user_8', username: 'Pierre', online: false }
];

let currentUser = null;
let friends = [];
let friendRequests = []; // Demandes reÃ§ues
let sentRequests = []; // Demandes envoyÃ©es
let currentTab = 'friends';

// Initialisation
function init() {
    loadCurrentUser();
    loadFriends();
    loadRequests();
    updateOnlineStatus();
    displayFriends();
    displayRequests();
    
    // Mettre Ã  jour le statut toutes les 30 secondes
    setInterval(updateOnlineStatus, 30000);
    
    // Event listener pour Enter sur l'input de recherche
    const searchInput = document.getElementById('searchUsername');
    if (searchInput) {
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUser();
            }
        });
    }
}

// Charger l'utilisateur actuel
function loadCurrentUser() {
    const userData = localStorage.getItem('current_user');
    if (userData) {
        currentUser = JSON.parse(userData);
    } else {
        // CrÃ©er un utilisateur par dÃ©faut
        currentUser = { id: 'default_user', name: 'Joueur' };
        localStorage.setItem('current_user', JSON.stringify(currentUser));
    }
    console.log('ğŸ‘¤ Utilisateur actuel:', currentUser);
}

// Charger les amis depuis localStorage
function loadFriends() {
    const storedFriends = localStorage.getItem(`friends_${currentUser.id}`);
    if (storedFriends) {
        friends = JSON.parse(storedFriends);
        console.log('âœ… Amis chargÃ©s:', friends.length);
    }
}

// Charger les demandes depuis localStorage
function loadRequests() {
    const storedRequests = localStorage.getItem(`friend_requests_${currentUser.id}`);
    if (storedRequests) {
        friendRequests = JSON.parse(storedRequests);
    }
    
    const storedSent = localStorage.getItem(`sent_requests_${currentUser.id}`);
    if (storedSent) {
        sentRequests = JSON.parse(storedSent);
    }
    
    console.log('ğŸ“¬ Demandes reÃ§ues:', friendRequests.length);
    console.log('ğŸ“¤ Demandes envoyÃ©es:', sentRequests.length);
}

// Sauvegarder les amis dans localStorage
function saveFriends() {
    localStorage.setItem(`friends_${currentUser.id}`, JSON.stringify(friends));
    console.log('ğŸ’¾ Amis sauvegardÃ©s');
}

// Sauvegarder les demandes dans localStorage
function saveRequests() {
    localStorage.setItem(`friend_requests_${currentUser.id}`, JSON.stringify(friendRequests));
    localStorage.setItem(`sent_requests_${currentUser.id}`, JSON.stringify(sentRequests));
    console.log('ğŸ’¾ Demandes sauvegardÃ©es');
}

// Mettre Ã  jour le statut en ligne des amis
function updateOnlineStatus() {
    friends.forEach(friend => {
        const user = userDatabase.find(u => u.username.toLowerCase() === friend.name.toLowerCase());
        if (user) {
            friend.online = user.online;
        }
    });
    saveFriends();
    if (currentTab === 'friends') {
        displayFriends();
    }
}

// Rechercher un utilisateur
function searchUser() {
    const input = document.getElementById('searchUsername');
    const username = input.value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    if (!username) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    // Chercher dans la base de donnÃ©es
    const user = userDatabase.find(u => u.username.toLowerCase() === username.toLowerCase());
    
    if (!user) {
        resultsDiv.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">âŒ</div>
                <h3>Utilisateur introuvable</h3>
                <p>Aucun utilisateur ne correspond Ã  "${username}"</p>
            </div>
        `;
        return;
    }
    
    // VÃ©rifier si c'est dÃ©jÃ  un ami
    if (friends.some(f => f.name.toLowerCase() === user.username.toLowerCase())) {
        resultsDiv.innerHTML = `
            <div class="no-results">
                <div class="no-results-icon">âœ…</div>
                <h3>DÃ©jÃ  dans vos amis</h3>
                <p>${user.username} est dÃ©jÃ  dans votre liste d'amis</p>
            </div>
        `;
        return;
    }
    
    // VÃ©rifier si une demande est dÃ©jÃ  envoyÃ©e
    const alreadySent = sentRequests.some(r => r.username.toLowerCase() === user.username.toLowerCase());
    
    resultsDiv.innerHTML = `
        <div class="user-result">
            <div class="friend-info">
                <div class="friend-avatar">${user.username.substring(0, 2).toUpperCase()}</div>
                <div class="friend-details">
                    <div class="friend-name">${user.username}</div>
                    <div class="friend-status">
                        ${user.online ? 'ğŸŸ¢ En ligne' : 'âš« Hors ligne'}
                    </div>
                </div>
            </div>
            ${alreadySent 
                ? '<button class="btn-disabled" disabled>âœ… Demande envoyÃ©e</button>'
                : '<button class="btn-add" onclick="sendFriendRequest(\'' + user.id + '\', \'' + user.username + '\')">â• Ajouter</button>'
            }
        </div>
    `;
}

// Envoyer une demande d'ami
function sendFriendRequest(userId, username) {
    const request = {
        id: Date.now(),
        userId: userId,
        username: username,
        sentAt: Date.now()
    };
    
    sentRequests.push(request);
    saveRequests();
    
    showNotification(`âœ… Demande d'ami envoyÃ©e Ã  ${username}`, 'success');
    console.log('ğŸ“¤ Demande envoyÃ©e Ã :', username);
    
    // RafraÃ®chir la recherche
    searchUser();
    updateCounts();
}

// Accepter une demande d'ami
function acceptRequest(requestId) {
    const request = friendRequests.find(r => r.id === requestId);
    if (!request) return;
    
    // Ajouter aux amis
    const user = userDatabase.find(u => u.username.toLowerCase() === request.username.toLowerCase());
    const newFriend = {
        id: Date.now(),
        name: request.username,
        online: user ? user.online : false,
        addedAt: Date.now()
    };
    
    friends.push(newFriend);
    saveFriends();
    
    // Retirer de la liste des demandes
    friendRequests = friendRequests.filter(r => r.id !== requestId);
    saveRequests();
    
    showNotification(`âœ… ${request.username} a Ã©tÃ© ajoutÃ© Ã  vos amis`, 'success');
    console.log('âœ… Demande acceptÃ©e:', request.username);
    
    displayRequests();
    displayFriends();
    updateCounts();
}

// Refuser une demande d'ami
function declineRequest(requestId) {
    const request = friendRequests.find(r => r.id === requestId);
    if (!request) return;
    
    friendRequests = friendRequests.filter(r => r.id !== requestId);
    saveRequests();
    
    showNotification(`âŒ Demande de ${request.username} refusÃ©e`, 'info');
    console.log('âŒ Demande refusÃ©e:', request.username);
    
    displayRequests();
    updateCounts();
}

// Annuler une demande envoyÃ©e
function cancelSentRequest(requestId) {
    const request = sentRequests.find(r => r.id === requestId);
    if (!request) return;
    
    sentRequests = sentRequests.filter(r => r.id !== requestId);
    saveRequests();
    
    showNotification(`ğŸ—‘ï¸ Demande annulÃ©e`, 'info');
    console.log('ğŸ—‘ï¸ Demande annulÃ©e:', request.username);
    
    displayRequests();
    updateCounts();
}

// Supprimer un ami
function removeFriend(friendId) {
    const friend = friends.find(f => f.id === friendId);
    if (!friend) return;
    
    if (confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer ${friend.name} de vos amis ?`)) {
        friends = friends.filter(f => f.id !== friendId);
        saveFriends();
        displayFriends();
        showNotification(`ğŸ—‘ï¸ ${friend.name} a Ã©tÃ© retirÃ© de vos amis`, 'info');
        console.log('ğŸ—‘ï¸ Ami supprimÃ©:', friend.name);
        updateCounts();
    }
}

// Afficher les amis
function displayFriends() {
    const list = document.getElementById('friendsList');
    const countEl = document.getElementById('friendCount');
    
    countEl.textContent = friends.length;
    
    if (friends.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ‘¥</div>
                <h3>Aucun ami</h3>
                <p>Recherchez des utilisateurs pour les ajouter en amis</p>
            </div>
        `;
        return;
    }
    
    // Trier par statut (en ligne d'abord) puis par nom
    const sortedFriends = [...friends].sort((a, b) => {
        if (a.online !== b.online) {
            return b.online ? 1 : -1;
        }
        return a.name.localeCompare(b.name);
    });
    
    list.innerHTML = '';
    
    sortedFriends.forEach(friend => {
        const friendCard = document.createElement('div');
        friendCard.className = `friend-card ${friend.online ? 'online' : 'offline'}`;
        
        const initials = friend.name.substring(0, 2).toUpperCase();
        
        friendCard.innerHTML = `
            <div class="friend-info">
                <div class="friend-avatar">${initials}</div>
                <div class="friend-details">
                    <div class="friend-name">${friend.name}</div>
                    <div class="friend-status">
                        ${friend.online ? 'ğŸŸ¢ En ligne' : 'âš« Hors ligne'}
                    </div>
                </div>
            </div>
            <div class="friend-actions">
                ${friend.online ? '<button class="btn-trade" onclick="tradeWithFriend(' + friend.id + ')">ğŸ’± Trade</button>' : ''}
                <button class="btn-remove" onclick="removeFriend(${friend.id})">ğŸ—‘ï¸</button>
            </div>
        `;
        
        list.appendChild(friendCard);
    });
}

// Afficher les demandes
function displayRequests() {
    const requestsList = document.getElementById('requestsList');
    const sentList = document.getElementById('sentRequestsList');
    const countEl = document.getElementById('requestCount');
    
    countEl.textContent = friendRequests.length;
    
    // Demandes reÃ§ues
    if (friendRequests.length === 0) {
        requestsList.innerHTML = `
            <div class="empty-state-small">
                <p>Aucune demande reÃ§ue</p>
            </div>
        `;
    } else {
        requestsList.innerHTML = '';
        friendRequests.forEach(request => {
            const requestCard = document.createElement('div');
            requestCard.className = 'request-card';
            const initials = request.username.substring(0, 2).toUpperCase();
            
            requestCard.innerHTML = `
                <div class="friend-info">
                    <div class="friend-avatar">${initials}</div>
                    <div class="friend-details">
                        <div class="friend-name">${request.username}</div>
                        <div class="friend-status">Demande d'ami</div>
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="btn-accept" onclick="acceptRequest(${request.id})">âœ… Accepter</button>
                    <button class="btn-decline" onclick="declineRequest(${request.id})">âŒ Refuser</button>
                </div>
            `;
            requestsList.appendChild(requestCard);
        });
    }
    
    // Demandes envoyÃ©es
    if (sentRequests.length === 0) {
        sentList.innerHTML = `
            <div class="empty-state-small">
                <p>Aucune demande envoyÃ©e</p>
            </div>
        `;
    } else {
        sentList.innerHTML = '';
        sentRequests.forEach(request => {
            const requestCard = document.createElement('div');
            requestCard.className = 'request-card';
            const initials = request.username.substring(0, 2).toUpperCase();
            
            requestCard.innerHTML = `
                <div class="friend-info">
                    <div class="friend-avatar">${initials}</div>
                    <div class="friend-details">
                        <div class="friend-name">${request.username}</div>
                        <div class="friend-status">En attente...</div>
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="btn-cancel" onclick="cancelSentRequest(${request.id})">ğŸ—‘ï¸ Annuler</button>
                </div>
            `;
            sentList.appendChild(requestCard);
        });
    }
}

// Changer d'onglet
function switchTab(tab) {
    currentTab = tab;
    
    // Mettre Ã  jour les boutons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Mettre Ã  jour le contenu
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    if (tab === 'friends') {
        document.getElementById('friendsTab').classList.add('active');
    } else if (tab === 'requests') {
        document.getElementById('requestsTab').classList.add('active');
    } else if (tab === 'search') {
        document.getElementById('searchTab').classList.add('active');
    }
}

// Mettre Ã  jour les compteurs
function updateCounts() {
    document.getElementById('friendCount').textContent = friends.length;
    document.getElementById('requestCount').textContent = friendRequests.length;
}

// Aller Ã  la page de trade avec cet ami
function tradeWithFriend(friendId) {
    const friend = friends.find(f => f.id === friendId);
    if (friend) {
        localStorage.setItem('selectedFriendForTrade', JSON.stringify(friend));
        window.location.href = 'trade.html';
    }
}

// Afficher une notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Ajouter des demandes de test (Ã  supprimer en production)
function addTestRequests() {
    if (friendRequests.length === 0) {
        friendRequests = [
            { id: Date.now(), userId: 'user_2', username: 'Maxime', sentAt: Date.now() - 3600000 },
            { id: Date.now() + 1, userId: 'user_3', username: 'Sophie', sentAt: Date.now() - 7200000 }
        ];
        saveRequests();
        displayRequests();
        updateCounts();
    }
}

// DÃ©marrer l'application
init();
// DÃ©commenter pour ajouter des demandes de test
// addTestRequests();
